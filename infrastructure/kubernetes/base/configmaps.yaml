apiVersion: v1
kind: ConfigMap
metadata:
  name: splitter-common-config
  namespace: splitter
data:
  SPRING_PROFILES_ACTIVE: "production"
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
  OTEL_TRACES_SAMPLER: "parentbased_traceidratio"
  OTEL_TRACES_SAMPLER_ARG: "0.1"
  KAFKA_BOOTSTRAP_SERVERS: "kafka-0.kafka-headless:9092,kafka-1.kafka-headless:9092,kafka-2.kafka-headless:9092"
  REDIS_HOST: "redis-master"
  REDIS_PORT: "6379"
  LOG_LEVEL: "INFO"
  TZ: "UTC"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-config
  namespace: splitter
data:
  application-production.yml: |
    server:
      port: 8081
    
    spring:
      application:
        name: api-gateway
      cloud:
        gateway:
          routes:
            - id: user-service
              uri: http://user-service:8082
              predicates:
                - Path=/api/v1/users/**,/api/v1/auth/**
            - id: group-service
              uri: http://group-service:8083
              predicates:
                - Path=/api/v1/groups/**
            - id: expense-service
              uri: http://expense-service:8084
              predicates:
                - Path=/api/v1/expenses/**
            - id: balance-service
              uri: http://balance-service:8085
              predicates:
                - Path=/api/v1/balances/**
            - id: settlement-service
              uri: http://settlement-service:8086
              predicates:
                - Path=/api/v1/settlements/**
            - id: currency-service
              uri: http://currency-service:8087
              predicates:
                - Path=/api/v1/currencies/**
            - id: receipt-service
              uri: http://receipt-service:8088
              predicates:
                - Path=/api/v1/receipts/**
            - id: payment-service
              uri: http://payment-service:8089
              predicates:
                - Path=/api/v1/payments/**
            - id: analytics-service
              uri: http://analytics-service:8090
              predicates:
                - Path=/api/v1/analytics/**
    
    management:
      endpoints:
        web:
          exposure:
            include: health,info,prometheus,metrics
      endpoint:
        health:
          show-details: when_authorized
          probes:
            enabled: true
      metrics:
        tags:
          application: ${spring.application.name}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentbit-config
  namespace: splitter
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush        1
        Log_Level    info
        Parsers_File parsers.conf
    
    [INPUT]
        Name             tail
        Path             /var/log/containers/*splitter*.log
        Parser           docker
        Tag              kube.*
        Refresh_Interval 5
        Mem_Buf_Limit    5MB
    
    [FILTER]
        Name   kubernetes
        Match  kube.*
        Merge_Log On
        K8S-Logging.Parser On
    
    [OUTPUT]
        Name            es
        Match           *
        Host            elasticsearch
        Port            9200
        Index           splitter-logs
        Type            _doc
        
  parsers.conf: |
    [PARSER]
        Name        docker
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On
