name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  JAVA_VERSION: '21'

jobs:
  # Secret scanning with TruffleHog
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # Dependency vulnerability scanning
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api-gateway
          - user-service
          - group-service
          - expense-service
          - balance-service
          - settlement-service
          - notification-service
          - currency-service
          - receipt-service
          - payment-service
          - analytics-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'splitter-${{ matrix.service }}'
          path: './services/${{ matrix.service }}'
          format: 'HTML,JSON,SARIF'
          out: 'reports/dependency-check/${{ matrix.service }}'
          args: >
            --suppression .dependency-check-suppression.xml
            --failOnCVSS 7
            --enableRetired
            --enableExperimental

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-${{ matrix.service }}
          path: reports/dependency-check/${{ matrix.service }}

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/dependency-check/${{ matrix.service }}/dependency-check-report.sarif

  # Static Application Security Testing (SAST)
  sast-scan:
    name: SAST Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: security-extended,security-and-quality

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean compile -DskipTests -q

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

  # Semgrep SAST
  semgrep-scan:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config=p/java \
            --config=p/owasp-top-ten \
            --config=p/security-audit \
            --config=p/secrets \
            --sarif \
            --output=semgrep-results.sarif \
            --exclude='**/test/**' \
            --exclude='**/target/**'

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep-results.sarif

  # Container image scanning
  container-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    needs: [dependency-scan]
    strategy:
      matrix:
        service:
          - api-gateway
          - user-service
          - group-service
          - expense-service
          - balance-service
          - settlement-service
          - notification-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR
        run: |
          cd services/${{ matrix.service }}
          mvn package -DskipTests -q

      - name: Build Docker image
        run: |
          docker build -t splitter/${{ matrix.service }}:${{ github.sha }} \
            ./services/${{ matrix.service }}

      - name: Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'splitter/${{ matrix.service }}:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-${{ matrix.service }}.sarif

      - name: Grype Container Scan
        uses: anchore/scan-action@v4
        with:
          image: 'splitter/${{ matrix.service }}:${{ github.sha }}'
          fail-build: true
          severity-cutoff: high
          output-format: sarif

      - name: Upload Grype SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  # Infrastructure as Code scanning
  iac-scan:
    name: IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkov IaC Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/
          framework: kubernetes,dockerfile
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: false

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif

      - name: KubeSec Scan
        run: |
          curl -sSL https://github.com/controlplaneio/kubesec/releases/download/v2.13.0/kubesec_linux_amd64.tar.gz | tar xz
          chmod +x kubesec
          
          for file in infrastructure/kubernetes/base/deployments/*.yaml; do
            echo "Scanning $file"
            ./kubesec scan "$file" | tee -a kubesec-results.json
          done

      - name: Upload KubeSec Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kubesec-results
          path: kubesec-results.json

  # License compliance check
  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Generate License Report
        run: |
          mvn license:aggregate-third-party-report -DskipTests

      - name: Check for Prohibited Licenses
        run: |
          # Fail if GPL, AGPL, or other copyleft licenses are found
          if grep -E "(GPL|AGPL|LGPL|Affero)" target/site/third-party-report.html; then
            echo "::error::Copyleft license detected!"
            exit 1
          fi

      - name: Upload License Report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: target/site/third-party-report.html

  # Security report aggregation
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-scan, sast-scan, semgrep-scan, container-scan, iac-scan]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Generate Security Summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "| Scan Type | Status |" >> security-summary.md
          echo "|-----------|--------|" >> security-summary.md
          echo "| Secret Scanning | ${{ needs.secret-scanning.result }} |" >> security-summary.md
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> security-summary.md
          echo "| SAST (CodeQL) | ${{ needs.sast-scan.result }} |" >> security-summary.md
          echo "| SAST (Semgrep) | ${{ needs.semgrep-scan.result }} |" >> security-summary.md
          echo "| Container Scan | ${{ needs.container-scan.result }} |" >> security-summary.md
          echo "| IaC Scan | ${{ needs.iac-scan.result }} |" >> security-summary.md
          echo "" >> security-summary.md
          echo "Generated at: $(date -u)" >> security-summary.md

      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md

      - name: Post Summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # DAST preparation (runs on staging deployment)
  dast-preparation:
    name: DAST Preparation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [container-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create ZAP Context
        run: |
          cat > zap-context.yaml << 'EOF'
          env:
            contexts:
              - name: "Splitter API"
                urls:
                  - "https://api.staging.splitter.com"
                includePaths:
                  - "https://api.staging.splitter.com/api/.*"
                excludePaths:
                  - "https://api.staging.splitter.com/actuator/.*"
                authentication:
                  method: "json"
                  parameters:
                    loginUrl: "https://api.staging.splitter.com/api/v1/auth/login"
                    loginRequestData: '{"email":"test@example.com","password":"testpass"}'
                    tokenName: "token"
                    headerName: "Authorization"
                    headerPrefix: "Bearer "
          EOF

      - name: Upload ZAP Context
        uses: actions/upload-artifact@v4
        with:
          name: zap-context
          path: zap-context.yaml
